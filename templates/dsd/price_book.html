{% extends "dsd/base.html" %}
{% block title %}{{ vendor.vendor_code }} Price Book{% endblock %}

{% block extra_css %}
<style>
    .price-row td        { font-size: 16px; white-space: nowrap; }
    .price-row td.mono   { font-size: 16px; }
    .price-row td.desc   { white-space: nowrap; max-width: 260px; overflow: hidden; text-overflow: ellipsis; }
    .pack-sub            { font-size: 12px; color: var(--text-muted); font-family: var(--mono); white-space: nowrap; }
    .cost-changed        { color: var(--warning); font-size: 12px; font-family: var(--mono); white-space: nowrap; }
    .pending-indicator   { display: inline-block; width: 7px; height: 7px; background: var(--accent);
                           border-radius: 50%; margin-right: 5px; vertical-align: middle; }
    .margin-display      { font-family: var(--mono); font-size: 16px; }
    th                   { font-size: 12px; white-space: nowrap; cursor: pointer; user-select: none; }
    th.sortable:hover    { color: var(--accent); }
    th .sort-icon        { font-size: 10px; margin-left: 3px; color: var(--text-muted); }
    th.sort-asc  .sort-icon::after { content: ' ▲'; color: var(--accent); }
    th.sort-desc .sort-icon::after { content: ' ▼'; color: var(--accent); }
    th:not(.sort-asc):not(.sort-desc) .sort-icon::after { content: ' ⇅'; }
    .reset-sort          { font-size: 11px; font-family: var(--mono); color: var(--text-muted);
                           cursor: pointer; text-decoration: underline; margin-left: 12px; }
    .reset-sort:hover    { color: var(--accent); }
    /* Group header row inside the single table */
    tr.group-header-row  { background: var(--surface3) !important; }
    tr.group-header-row td { padding: 6px 12px; font-size: 12px; font-family: var(--mono);
                             border-top: 2px solid var(--border); }
    .group-hdr-code      { color: var(--accent); font-weight: 700; margin-right: 10px; }
    .group-hdr-name      { color: var(--text); margin-right: 10px; }
    .group-hdr-count     { color: var(--text-muted); margin-right: 16px; }
    /* Vendor quick-jump */
    .vendor-jump         { position: relative; width: 280px; }
    .vendor-jump input   { width: 100%; background: var(--surface2); border: 1px solid var(--border);
                           color: var(--text); padding: 7px 12px; border-radius: 6px;
                           font-size: 14px; font-family: var(--mono); outline: none; box-sizing: border-box; }
    .vendor-jump input:focus { border-color: var(--accent); }
    .vendor-jump input::placeholder { color: var(--text-muted); }
    .jump-dropdown       { display: none; position: absolute; top: 100%; left: 0; right: 0;
                           background: var(--surface2); border: 1px solid var(--border);
                           border-top: none; border-radius: 0 0 6px 6px;
                           max-height: 300px; overflow-y: auto; z-index: 1000; }
    .jump-option         { padding: 8px 12px; cursor: pointer; display: flex; gap: 10px; align-items: baseline; }
    .jump-option:hover,
    .jump-option.active  { background: var(--surface3); }
    .jump-code           { font-family: var(--mono); color: var(--accent); font-size: 13px; min-width: 75px; }
    .jump-name           { color: var(--text-muted); font-size: 13px; overflow: hidden;
                           text-overflow: ellipsis; white-space: nowrap; }
</style>
{% endblock %}

{% block content %}

<!-- Page Header -->
<div class="page-header">
    <div>
        <div class="flex items-center gap-12">
            <a href="{% url 'dsd:vendor_list' %}" style="color:var(--text-muted);text-decoration:none;font-size:13px;">← Price Books</a>
        </div>
        <div class="page-title" style="margin-top:6px;">
            <span style="color:var(--accent);font-family:var(--mono);">{{ vendor.vendor_code }}</span>
            &nbsp;{{ vendor.vendor_name }}
        </div>
        <div class="page-subtitle">
            {{ item_count }} item{{ item_count|pluralize }}
            {% if vendor.rep_name %}&nbsp;·&nbsp; Rep: {{ vendor.rep_name }}{% endif %}
            {% if vendor.rep_email %}&nbsp;·&nbsp;<a href="mailto:{{ vendor.rep_email }}" style="color:var(--text-muted);">{{ vendor.rep_email }}</a>{% endif %}
        </div>
    </div>
    <div class="flex gap-8 items-center">
        <div class="vendor-jump">
            <input type="text" id="vendorJump" placeholder="Jump to vendor..." autocomplete="off">
            <div class="jump-dropdown" id="jumpDropdown"></div>
        </div>
        {% if vendor.pending_cost_change_count %}
        <a href="{% url 'dsd:pending_changes' %}?vendor={{ vendor.vendor_code }}" class="btn btn-secondary">
            <span style="color:var(--accent);">●</span> {{ vendor.pending_cost_change_count }} Pending
        </a>
        {% endif %}
    </div>
</div>

<!-- Legend -->
<div class="flex gap-16 mb-16" style="font-size:11px;color:var(--text-muted);font-family:var(--mono);">
    <span><span class="pending-indicator"></span>Pending cost change</span>
    <span style="color:var(--danger);">■</span>&nbsp;Discontinued
    <span style="color:var(--warning);">■</span>&nbsp;TPR active
    <span style="color:var(--success);">▲</span>&nbsp;Margin ≥ 25%
    <span style="color:var(--warning);">▼</span>&nbsp;Margin 20–25%
    <span style="color:var(--danger);">▼</span>&nbsp;Margin &lt; 20%
</div>

<!-- Single table for entire vendor -->
<div class="card">
    <div class="table-wrap">
        <table id="mainTable">
            <thead>
                <tr>
                    <th class="sortable" data-col="0" data-type="str">Description<span class="sort-icon"></span></th>
                    <th class="sortable" data-col="1" data-type="str">UPC<span class="sort-icon"></span></th>
                    <th class="sortable right" data-col="2" data-type="num">Case Cost<span class="sort-icon"></span></th>
                    <th class="right">Allow</th>
                    <th class="sortable right" data-col="4" data-type="num">Unit Cost<span class="sort-icon"></span></th>
                    <th class="sortable right" data-col="5" data-type="num">Retail<span class="sort-icon"></span></th>
                    <th class="sortable right" data-col="6" data-type="num">GM%<span class="sort-icon"></span></th>
                    <th class="sortable" data-col="7" data-type="str">Last Chg<span class="sort-icon"></span></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>

            {% for key, group in groups.items %}
            <!-- Group header row -->
            <tr class="group-header-row" data-group="{{ group.link_group.link_code }}" data-seq="-1">
                <td colspan="9">
                    <span class="group-hdr-code">{{ group.link_group.link_code }}</span>
                    <span class="group-hdr-name">{{ group.link_group.link_group_name }}</span>
                    <span class="group-hdr-count">{{ group.items|length }} item{{ group.items|length|pluralize }}</span>
                    <span class="reset-sort" onclick="resetGroup('{{ group.link_group.link_code }}')">↺ Reset order</span>
                </td>
            </tr>
            {% for item in group.items %}
            <tr class="price-row {% if item.is_disco %}row-disco{% endif %} {% if item.has_pending_cost_change %}row-pending{% endif %}"
                data-seq="{{ item.seq|default:9999 }}" data-group="{{ group.link_group.link_code }}">
                <td class="desc">
                    {% if item.has_pending_cost_change %}<span class="pending-indicator" title="Pending cost change"></span>{% endif %}
                    <a href="{% url 'dsd:item_detail' vendor.vendor_code item.upc %}" style="color:var(--text);text-decoration:none;font-weight:500;max-width:260px;display:inline-block;overflow:hidden;text-overflow:ellipsis;vertical-align:bottom;">{{ item.description }}</a>
                    {% if item.is_disco %}<span class="badge badge-disco" style="margin-left:4px;">DISCO</span>{% endif %}
                    {% if item.is_tpr %}<span class="badge badge-tpr" style="margin-left:4px;">TPR</span>{% endif %}
                    <div class="pack-sub">{{ item.case_pack }}{% if item.size_alpha %} / {{ item.size_alpha }}{% endif %}</div>
                </td>
                <td class="mono muted" style="font-size:15px;">{{ item.upc }}</td>
                <td class="right mono">
                    ${{ item.case_cost }}
                    {% if item.has_pending_cost_change %}<div class="cost-changed">→ ${{ item.pending_cost_change.new_case_cost }}</div>{% endif %}
                </td>
                <td class="right mono">{% if item.allowance %}${{ item.allowance }}{% else %}—{% endif %}</td>
                <td class="right mono">
                    {% if item.unit_cost %}${{ item.unit_cost|floatformat:2 }}{% else %}—{% endif %}
                    {% if item.has_pending_cost_change and item.pending_cost_change.new_unit_cost %}<div class="cost-changed">→ ${{ item.pending_cost_change.new_unit_cost|floatformat:2 }}</div>{% endif %}
                </td>
                <td class="right mono" style="font-weight:600;">
                    {% if item.retail_price %}${{ item.retail_price }}{% else %}—{% endif %}
                    {% if item.has_pending_cost_change and item.pending_cost_change.suggested_retail %}<div class="cost-changed" style="color:var(--accent2);">→ ${{ item.pending_cost_change.suggested_retail }}</div>{% endif %}
                </td>
                <td class="right">
                    {% if item.margin %}<span class="margin-display {% if item.margin >= 0.25 %}margin-good{% elif item.margin >= 0.20 %}margin-low{% else %}margin-bad{% endif %}">{{ item.margin_pct }}</span>{% else %}—{% endif %}
                </td>
                <td class="mono muted" style="font-size:15px;">{{ item.last_cost_change|date:"m/d/y"|default:"—" }}</td>
                <td><a href="{% url 'dsd:cost_change_entry' vendor.vendor_code item.upc %}" class="btn btn-secondary btn-sm">{% if item.has_pending_cost_change %}Edit{% else %}Change{% endif %}</a></td>
            </tr>
            {% endfor %}
            {% endfor %}

            {% if ungrouped %}
            <!-- Ungrouped header row -->
            <tr class="group-header-row" data-group="__ungrouped__" data-seq="-1">
                <td colspan="9">
                    <span class="group-hdr-name" style="color:var(--text-muted);">Ungrouped Items</span>
                    <span class="group-hdr-count">{{ ungrouped|length }} item{{ ungrouped|length|pluralize }}</span>
                    <span class="reset-sort" onclick="resetGroup('__ungrouped__')">↺ Reset order</span>
                </td>
            </tr>
            {% for item in ungrouped %}
            <tr class="price-row {% if item.is_disco %}row-disco{% endif %} {% if item.has_pending_cost_change %}row-pending{% endif %}"
                data-seq="{{ item.seq|default:9999 }}" data-group="__ungrouped__">
                <td class="desc">
                    {% if item.has_pending_cost_change %}<span class="pending-indicator"></span>{% endif %}
                    <a href="{% url 'dsd:item_detail' vendor.vendor_code item.upc %}" style="color:var(--text);text-decoration:none;font-weight:500;max-width:260px;display:inline-block;overflow:hidden;text-overflow:ellipsis;vertical-align:bottom;">{{ item.description }}</a>
                    {% if item.is_disco %}<span class="badge badge-disco" style="margin-left:4px;">DISCO</span>{% endif %}
                    {% if item.is_tpr %}<span class="badge badge-tpr" style="margin-left:4px;">TPR</span>{% endif %}
                    <div class="pack-sub">{{ item.case_pack }}{% if item.size_alpha %} / {{ item.size_alpha }}{% endif %}</div>
                </td>
                <td class="mono muted" style="font-size:15px;">{{ item.upc }}</td>
                <td class="right mono">${{ item.case_cost }}</td>
                <td class="right mono">{% if item.allowance %}${{ item.allowance }}{% else %}—{% endif %}</td>
                <td class="right mono">{% if item.unit_cost %}${{ item.unit_cost|floatformat:2 }}{% else %}—{% endif %}</td>
                <td class="right mono" style="font-weight:600;">{% if item.retail_price %}${{ item.retail_price }}{% else %}—{% endif %}</td>
                <td class="right">
                    {% if item.margin %}<span class="margin-display {% if item.margin >= 0.25 %}margin-good{% elif item.margin >= 0.20 %}margin-low{% else %}margin-bad{% endif %}">{{ item.margin_pct }}</span>{% else %}—{% endif %}
                </td>
                <td class="mono muted" style="font-size:15px;">{{ item.last_cost_change|date:"m/d/y"|default:"—" }}</td>
                <td><a href="{% url 'dsd:cost_change_entry' vendor.vendor_code item.upc %}" class="btn btn-secondary btn-sm">Change</a></td>
            </tr>
            {% endfor %}
            {% endif %}

            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const VENDORS = [
{% for v in all_vendors %}
  { code: "{{ v.vendor_code }}", name: "{{ v.vendor_name }}", url: "{% url 'dsd:price_book' v.vendor_code %}" },
{% endfor %}
];

// ── Vendor quick-jump ─────────────────────────────────────
const jumpInput = document.getElementById('vendorJump');
const jumpDrop  = document.getElementById('jumpDropdown');
let activeIdx   = -1;

function showDropdown(matches) {
    jumpDrop.innerHTML = '';
    activeIdx = -1;
    if (!matches.length) { jumpDrop.style.display = 'none'; return; }
    matches.forEach(v => {
        const d = document.createElement('div');
        d.className = 'jump-option';
        d.innerHTML = '<span class="jump-code">' + v.code + '</span><span class="jump-name">' + v.name + '</span>';
        d.addEventListener('mousedown', () => { window.location.href = v.url; });
        jumpDrop.appendChild(d);
    });
    jumpDrop.style.display = 'block';
}

jumpInput.addEventListener('input', () => {
    const q = jumpInput.value.trim().toLowerCase();
    if (!q) { jumpDrop.style.display = 'none'; return; }
    showDropdown(VENDORS.filter(v => v.code.toLowerCase().includes(q) || v.name.toLowerCase().includes(q)).slice(0, 12));
});

jumpInput.addEventListener('keydown', e => {
    const opts = jumpDrop.querySelectorAll('.jump-option');
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        activeIdx = Math.min(activeIdx + 1, opts.length - 1);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        activeIdx = Math.max(activeIdx - 1, 0);
    } else if (e.key === 'Enter') {
        e.preventDefault();
        const target = activeIdx >= 0 ? opts[activeIdx] : opts[0];
        if (target) target.dispatchEvent(new Event('mousedown'));
        return;
    } else if (e.key === 'Escape') {
        jumpDrop.style.display = 'none'; return;
    }
    opts.forEach((o, i) => o.classList.toggle('active', i === activeIdx));
    if (opts[activeIdx]) opts[activeIdx].scrollIntoView({ block: 'nearest' });
});

let isSelecting = false;
jumpDrop.addEventListener('mousedown', () => { isSelecting = true; });
jumpDrop.addEventListener('mouseup',   () => { isSelecting = false; });
jumpInput.addEventListener('blur', () => { if (!isSelecting) jumpDrop.style.display = 'none'; });

// ── Column sort (within each group independently) ─────────
function getCellVal(row, colIdx) {
    const cells = row.querySelectorAll('td');
    return cells[colIdx] ? cells[colIdx].innerText.trim() : '';
}

function getGroupRows(groupKey) {
    return Array.from(document.querySelectorAll(`tr.price-row[data-group="${groupKey}"]`));
}

function sortGroup(groupKey, colIdx, isNum, ascending) {
    const rows = getGroupRows(groupKey);
    if (!rows.length) return;
    const headerRow = document.querySelector(`tr.group-header-row[data-group="${groupKey}"]`);
    rows.sort((a, b) => {
        let av = getCellVal(a, colIdx);
        let bv = getCellVal(b, colIdx);
        if (isNum) {
            av = parseFloat(av.replace(/[^0-9.\-]/g, '')) || 0;
            bv = parseFloat(bv.replace(/[^0-9.\-]/g, '')) || 0;
            return ascending ? av - bv : bv - av;
        }
        return ascending ? av.localeCompare(bv, undefined, {numeric:true}) : bv.localeCompare(av, undefined, {numeric:true});
    });
    // Re-insert after the group header row
    let ref = headerRow;
    rows.forEach(r => {
        ref.parentNode.insertBefore(r, ref.nextSibling);
        ref = r;
    });
}

function resetGroup(groupKey) {
    const rows = getGroupRows(groupKey);
    const headerRow = document.querySelector(`tr.group-header-row[data-group="${groupKey}"]`);
    rows.sort((a, b) => parseInt(a.dataset.seq||9999) - parseInt(b.dataset.seq||9999));
    let ref = headerRow;
    rows.forEach(r => {
        ref.parentNode.insertBefore(r, ref.nextSibling);
        ref = r;
    });
}

// Get all unique group keys in order
function allGroupKeys() {
    return [...new Set(
        Array.from(document.querySelectorAll('tr.price-row')).map(r => r.dataset.group)
    )];
}

document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
        const colIdx = parseInt(th.dataset.col);
        const isNum  = th.dataset.type === 'num';
        const isAsc  = th.classList.contains('sort-asc');
        document.querySelectorAll('th.sortable').forEach(t => t.classList.remove('sort-asc','sort-desc'));
        th.classList.add(isAsc ? 'sort-desc' : 'sort-asc');
        allGroupKeys().forEach(gk => sortGroup(gk, colIdx, isNum, !isAsc));
    });
});
</script>
{% endblock %}
